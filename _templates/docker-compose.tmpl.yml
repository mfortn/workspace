services:
  api-php:
    build:
      context: ./api
      dockerfile: ./docker/api.Dockerfile
    container_name: ${PROJECT}_api_php
    working_dir: /var/www/html
    volumes:
      - ./api:/var/www/html
    environment:
      - APP_ENV=local
      - COMPOSER_MEMORY_LIMIT=-1
    depends_on:
      db:
        condition: service_healthy
    networks:
      - internal

  api-nginx:
    image: nginx:alpine
    container_name: ${PROJECT}_api_nginx
    volumes:
      - ./api:/var/www/html:rw
      - ./api/docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "${APP_PORT}:80"
    depends_on:
      api-php:
        condition: service_started
    networks:
      - internal

  db:
    image: mysql:8.0
    container_name: ${PROJECT}_db
    environment:
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - ./_data/mysql:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-p${DB_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - internal

  redis:
    image: redis:alpine
    container_name: ${PROJECT}_redis
    networks:
      - internal

  vue-builder:
    image: node:lts
    container_name: ${PROJECT}_vue_builder
    working_dir: /app
    volumes:
      - ./default:/app
    networks:
      - internal

  vue-web:
    image: nginx:alpine
    container_name: ${PROJECT}_vue_web
    volumes:
      - ./default/dist:/usr/share/nginx/html:ro
    ports:
      - "${VUE_PORT}:80"
    depends_on:
      - vue-builder
    networks:
      - internal

networks:
  internal:
    name: ${PROJECT}_net
